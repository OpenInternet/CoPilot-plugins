#!/usr/bin/env bash

#set -x

readonly IPTABLE_RULE="FORWARD -j NFQUEUE"
readonly SURICATA_CONFIG="/etc/suricata/copilot.conf.yaml"
readonly PID_FILE="/var/run/suricata.pid"
# Rules not currently used, but kept here if needed
readonly SURICATA_RULES="/tmp/copilot/copilot-suricata.rules"
#readonly SURICATA_EMPTY="/etc/suricata/copilot_norules.conf"

start_suricata() {
    kill_current_suricata
    # Check if there is a rule file
    if [[ -e "$SURICATA_RULES" ]]; then
        echo "Starting example configuration"
        iptables -I ${IPTABLE_RULE}
        touch "${PID_FILE}"
        # Start suricata with config (rule file location is in config)
        suricata -q 0 -c "$SURICATA_CONFIG" --pidfile "${PID_FILE}"
    else
        echo "No Rule file found. Not starting Suricata"
        #suricata -c "$SURICATA_EMPTY"
        echo "Ignore the upcoming error message from iptables"
        echo "We didn't create a rule, so it will not be able to delete one."
    fi
}

kill_current_suricata() {
    if [ -f $PID_FILE ]; then
        PID1=$(cat $PID_FILE)
        if kill -0 "$PID1" 2>/dev/null; then
            kill "$PID1"
            if [ -e "${PID_FILE}" ]; then
                rm "${PID_FILE}" > /dev/null 2>&1
            fi
        fi
    fi
}

clean_up() {
    echo "I am cleaning up after myself here."
    kill_current_suricata
    iptables -D ${IPTABLE_RULE}
    exit 0
}


main() {
    start_suricata
}
trap 'clean_up' EXIT SIGTERM
main
